# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Ruby command-line tool that extracts and visualizes PDF chapter structure in Markdown format. The project consists of a single Ruby script that reads PDF files and outputs their outline/bookmark structure.

### Ruby Version
- Ruby 3.4.4 (specified in `.ruby-version`)
- Managed via rbenv, rvm, asdf, or other Ruby version managers

## Development Commands

### Install dependencies
```bash
bundle install
```

### Run the script
```bash
bundle exec ruby pdf_chapter_tree.rb [options] path/to/file.pdf

# Or make it executable and run directly
chmod +x pdf_chapter_tree.rb
./pdf_chapter_tree.rb [options] path/to/file.pdf

# Show help
bundle exec ruby pdf_chapter_tree.rb -h

# Show only 2 levels of hierarchy
bundle exec ruby pdf_chapter_tree.rb -d 2 path/to/file.pdf

# Show in tree format
bundle exec ruby pdf_chapter_tree.rb -t path/to/file.pdf

# Use 4-space indent (for Obsidian compatibility)
bundle exec ruby pdf_chapter_tree.rb -i 4 path/to/file.pdf

# Combine options: tree format with depth limit
bundle exec ruby pdf_chapter_tree.rb -t -d 2 path/to/file.pdf

# Combine indent with depth limit
bundle exec ruby pdf_chapter_tree.rb -i 4 -d 2 path/to/file.pdf
```

### Run tests
```bash
bundle exec rspec
# Run specific test file
bundle exec rspec spec/pdf_chapter_tree_spec.rb
# Run specific test line
bundle exec rspec spec/pdf_chapter_tree_spec.rb:42
```

### Linting
```bash
# Check for issues
bundle exec rubocop

# Auto-correct safe issues
bundle exec rubocop -a

# Auto-correct all issues (including unsafe)
bundle exec rubocop -A
```

## Architecture

### Core Implementation
- `pdf_chapter_tree.rb` - Main script containing the `PDFChapterTree` class
  - Uses `pdf-reader` gem to extract PDF outline information via objects API
  - Converts outline to hierarchical Markdown format
  - Includes error handling for missing files, non-PDF files, and malformed PDFs
  - Script is executable with shebang line
  - Handles encoding issues (UTF-16BE, UTF-8) for international PDFs

### Key Design Decisions
- Single-file script architecture for simplicity
- Uses PDF::Reader 2.x objects API to access PDF catalog and outline structure
- Page numbers extracted from PDF outline destinations when available
- Recursive processing for nested chapter structures
- Output format: Markdown with chapter titles and page numbers in parentheses
- Encoding handling for international characters (especially Japanese PDFs)

### Key Methods
- `extract_chapters` - Main method to extract outline from PDF using objects API
- `parse_outline_item` - Recursively processes outline items and their children/siblings
- `decode_pdf_string` - Handles encoding conversion (UTF-16BE to UTF-8) and cleans up strings
- `extract_page_number` - Extracts page numbers from PDF destinations
  - Handles array-based destinations (standard format)
  - Handles named destinations (string format like "p35")
  - Resolves Action objects containing destinations
- `to_markdown` - Converts extracted chapters to Markdown format
  - Accepts `max_depth` parameter to limit hierarchy levels
  - Accepts `indent` parameter to customize indentation (default: 2 spaces)
- `to_tree` - Converts extracted chapters to tree format
  - Accepts `max_depth` parameter to limit hierarchy levels
  - Uses box-drawing characters (├──, └──, │) for tree structure
- `render_chapters` - Renders chapters in Markdown list format with optional depth limiting
  - Uses configurable indent spacing for nested lists
- `render_tree` - Renders chapters in tree format with proper branch visualization
- `parse_options` - Parses command-line options using optparse

### Dependencies
- `pdf-reader` (~> 2.12) - For PDF parsing and outline extraction
- Development dependencies:
  - `prawn` (~> 2.5) - For generating test PDFs
  - `rspec` (~> 3.13) - Testing framework
  - `rubocop` (~> 1.69) - Ruby linter
  - `rubocop-performance` (~> 1.24) - Performance cops for RuboCop
  - `rubocop-rspec` (~> 3.3) - RSpec-specific cops for RuboCop

## Testing Notes

- Tests use generated PDF files in `spec/fixtures/`
- Test PDFs are created using Prawn gem via `spec/support/generate_test_pdfs.rb`
- Four test PDFs are included:
  - `sample_with_outline.pdf` - English PDF with chapter outline
  - `sample_without_outline.pdf` - PDF without outline
  - `japanese_with_outline.pdf` - Japanese PDF with UTF-16BE encoded outline
  - `named_dest_outline.pdf` - PDF simulating named destination format
- Test PDFs can be regenerated by running: `bundle exec ruby spec/support/generate_test_pdfs.rb`
- Japanese PDF test verifies proper handling of UTF-16BE encoding and hierarchical structure
- Named destination tests verify support for O'Reilly-style PDFs with string-based page references

## Command Line Options

- `-d, --depth LEVEL` - Display only LEVEL levels of hierarchy
  - Default: all levels (no limit)
  - Level counting starts from 1 (root level)
  - Indentation is preserved even with depth limits
- `-t, --tree` - Display output in tree format instead of Markdown list
  - Uses box-drawing characters for visual hierarchy
  - Compatible with `-d` option for depth limiting
- `-i, --indent SPACES` - Set indent spacing for Markdown format
  - Default: 2 spaces (standard Markdown)
  - Use 4 spaces for Obsidian compatibility
  - Does not affect tree format output
- `-h, --help` - Show help message with usage examples

## Common Tasks

### Update dependencies
```bash
bundle update
```

### Check outdated gems
```bash
bundle outdated
```

## Error Handling

The script handles the following error cases:
- File not found - raises error with clear message
- Non-PDF file - validates file extension before processing
- PDF without outline - returns friendly message instead of error
- Malformed PDF - catches PDF::Reader exceptions and provides helpful error message
- Encoding issues - automatically detects and converts UTF-16BE to UTF-8
- Invalid characters - replaces with '?' when conversion fails

## Encoding Support

The script properly handles:
- UTF-16BE encoding (common in Japanese PDFs)
- UTF-8 encoding
- BOM (Byte Order Mark) removal
- Invalid character replacement
- Whitespace trimming

## PDF Destination Formats

The script supports multiple PDF outline destination formats:
- **Array format**: Standard format with page reference objects
- **Named destinations**: String-based destinations like "p35" (common in O'Reilly and other technical publishers)
- **Action objects**: Destinations wrapped in Action dictionaries
- **Reference resolution**: Automatically resolves PDF object references

### Known Limitations
- Complex named destinations that require resolution through the PDF Names dictionary are not yet fully implemented
- Simple pattern-based named destinations (like "p35") are supported
